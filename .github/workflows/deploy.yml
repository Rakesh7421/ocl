# Failure info: dial tcp 172.182.225.194:22: i/o timeout
# Updated for server deployment
#
# Required secrets:
# - OCI_HOST: Public IP address of the OCI instance (e.g., 123.456.789.0)
# - OCI_USER: SSH username for the OCI instance (e.g., ubuntu or opc)
# - SSH_PRIVATE_KEY: Private SSH key content for connecting to OCI instance
# - NOIP_USERNAME: No-IP account username
# - NOIP_PASSWORD: No-IP account password
# - NOIP_HOST: Your No-IP domain name (e.g., yourname.ddns.net)
# - OCI_USER_OCID: OCI user OCID (found in OCI Console > Identity > Users > your user > OCID)
# - OCI_FINGERPRINT: OCI API key fingerprint (generate API key pair: openssl genrsa -out oci_api_key.pem 2048; openssl rsa -pubout -in oci_api_key.pem -out oci_api_key_public.pem; add public key in OCI Console > Identity > Users > your user > API Keys > Add Public Keys; fingerprint shown after adding)
# - OCI_PRIVATE_KEY: OCI private key content (content of the private key file oci_api_key.pem generated above)
# - OCI_TENANCY_OCID: OCI tenancy OCID (found in OCI Console > Administration > Tenancy Details > OCID)
# - OCI_REGION: OCI region (e.g., us-ashburn-1; found in OCI Console URL or region selector)
# - OCI_COMPARTMENT_OCID: OCI compartment OCID (found in OCI Console > Identity > Compartments > your compartment > OCID)
#
name: Deploy No-IP Callback Server

on:
  push:
    branches: [ Developing-yet ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Copy code to OCI instance
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.OCI_HOST }}
        username: ${{ secrets.OCI_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "noip-callback/"
        target: "~/"
    
    - name: Deploy to OCI instance
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.OCI_HOST }}
        username: ${{ secrets.OCI_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd noip-callback
          python3 -m venv venv
          source venv/bin/activate
          pip install -r requirements.txt
          echo "NOIP_USERNAME=${{ secrets.NOIP_USERNAME }}" > .env
          echo "NOIP_PASSWORD=${{ secrets.NOIP_PASSWORD }}" >> .env
          echo "NOIP_HOST=${{ secrets.NOIP_HOST }}" >> .env
          python noip_update.py
          nohup python app.py &
    
    - name: Check server is running on OCI
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.OCI_HOST }}
        username: ${{ secrets.OCI_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          sleep 5
          curl -I http://localhost:8080
          echo "Server check completed"
    - name: Check domain availability
      run: |
        sleep 10
        curl -I http://${{ secrets.NOIP_HOST }}:8080
        echo "Domain check completed"
    - name: Check OCI instance network configuration
      if: failure()
      run: |
        # Install OCI CLI
        pip install oci-cli

        # Create OCI config
        mkdir -p ~/.oci
        cat > ~/.oci/config << EOF
        [DEFAULT]
        user=${{ secrets.OCI_USER_OCID }}
        fingerprint=${{ secrets.OCI_FINGERPRINT }}
        key_file=~/.oci/private_key.pem
        tenancy=${{ secrets.OCI_TENANCY_OCID }}
        region=${{ secrets.OCI_REGION }}
        EOF
        echo "${{ secrets.OCI_PRIVATE_KEY }}" > ~/.oci/private_key.pem
        chmod 600 ~/.oci/private_key.pem

        # Test OCI authentication
        oci iam region list --output table

        # Get instance OCID by public IP
        INSTANCE_OCID=$(oci compute instance list --compartment-id ${{ secrets.OCI_COMPARTMENT_OCID }} --query "data[?\"public-ip\"=='${{ secrets.OCI_HOST }}'].id | [0]" --raw-output)
        echo "Instance OCID: $INSTANCE_OCID"
        
        # Get VNIC OCID
        VNIC_OCID=$(oci compute instance list-vnics --instance-id $INSTANCE_OCID --query "data[0].id" --raw-output)
        echo "VNIC OCID: $VNIC_OCID"
        
        # Get subnet OCID
        SUBNET_OCID=$(oci network vnic get --vnic-id $VNIC_OCID --query "data.\"subnet-id\"" --raw-output)
        echo "Subnet OCID: $SUBNET_OCID"
        
        # Get VCN OCID
        VCN_OCID=$(oci network subnet get --subnet-id $SUBNET_OCID --query "data.\"vcn-id\"" --raw-output)
        echo "VCN OCID: $VCN_OCID"
        
        # Get security list IDs
        SECURITY_LIST_IDS=$(oci network vnic get --vnic-id $VNIC_OCID --query "data.\"security-list-ids\" | join(' ', @)" --raw-output)
        echo "Security List IDs: $SECURITY_LIST_IDS"
        
        # Check ingress rules for each security list
        for SL_ID in $SECURITY_LIST_IDS; do
          echo "Security List $SL_ID ingress rules:"
          oci network security-list get --security-list-id $SL_ID --query "data.\"ingress-security-rules\""
        done

    - name: Wait for manual verification
      run: sleep 100
    
    - name: Check OCI network settings if domain unavailable
      if: failure()
      run: |
        echo "Domain not accessible publicly. Please check OCI network settings:"
        echo "- Ensure the Security List for the instance allows inbound traffic on port 8080 from 0.0.0.0/0"
        echo "- Verify the instance is assigned a public IP address"
        echo "- Confirm that the No-IP domain DNS has propagated (may take up to 5-10 minutes)"
        echo "- Check if the server is running correctly on the OCI instance"
