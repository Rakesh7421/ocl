# Failure info: dial tcp 172.182.225.194:22: i/o timeout
# Updated for server deployment
#
# Required secrets:
# - OCI_HOST: Public IP address of the OCI instance (e.g., 123.456.789.0)
# - OCI_USER: SSH username for the OCI instance (e.g., ubuntu or opc)
# - SSH_PRIVATE_KEY: Private SSH key content for connecting to OCI instance
# - NOIP_USERNAME: No-IP account username
# - NOIP_PASSWORD: No-IP account password
# - NOIP_HOST: Your No-IP domain name (e.g., yourname.ddns.net)
#129.154.244.155
name: Deploy No-IP Callback Server

on:
  push:
    branches: [ Developing-yet ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Copy code to OCI instance
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.OCI_HOST }}
        username: ${{ secrets.OCI_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "noip-callback/"
        target: "~/"
    
    - name: Deploy to OCI instance
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.OCI_HOST }}
        username: ${{ secrets.OCI_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd noip-callback
          python3 -m venv venv
          source venv/bin/activate
          pip install -r requirements.txt
          echo "NOIP_USERNAME=${{ secrets.NOIP_USERNAME }}" > .env
          echo "NOIP_PASSWORD=${{ secrets.NOIP_PASSWORD }}" >> .env
          echo "NOIP_HOST=${{ secrets.NOIP_HOST }}" >> .env
          python noip_update.py
          nohup python app.py &
    
    - name: Check server is running on OCI
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.OCI_HOST }}
        username: ${{ secrets.OCI_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          sleep 5
          curl -I http://localhost:8080
          echo "Server check completed"
    - name: Check domain availability
      run: |
        sleep 30
        curl -I http://${{ secrets.NOIP_HOST }}:8080
        echo "Domain check completed"

    - name: Wait for manual verification
      run: sleep 100
    
    - name: Check OCI network settings if domain unavailable
      if: failure()
      run: |
        echo "Domain not accessible publicly. Please check OCI network settings:"
        echo "- Ensure the Security List for the instance allows inbound traffic on port 8080 from 0.0.0.0/0"
        echo "- Verify the instance is assigned a public IP address"
        echo "- Confirm that the No-IP domain DNS has propagated (may take up to 5-10 minutes)"
        echo "- Check if the server is running correctly on the OCI instance"
